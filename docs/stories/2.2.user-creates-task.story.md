# Story 2.2: User Creates Task

## Status
Draft

## Story
**As a** project member,
**I want** to create new tasks within a project,
**so that** I can track my work and collaborate with my team.

## Acceptance Criteria
1. An authorized user (project member) can create a new task in a specific column of a board.
2. The new task must have a title, priority, and an initial completion percentage.
3. The task can optionally have a description, an assignee (user), and a due date.
4. A new `ActivityLog` entry is created to record the task creation event.
5. The API returns the details of the newly created task upon successful creation.
6. Unauthorized users (i.e., not members of the board) are prevented from creating tasks in that board.

## Tasks / Subtasks
- [ ] Create `CardRequest` DTO for task creation, including `columnId`, `title`, `description`, `assigneeId`, `priority`, `dueDate`, `completionPercentage`. (AC: 1, 2, 3)
- [ ] Create `CardResponse` DTO to return the full details of the created task. (AC: 5)
- [ ] Implement `CardService` with a `createCard` method. (AC: 1, 2, 3, 4)
  - [ ] Validate that the `columnId` and `assigneeId` (if provided) exist.
  - [ ] Verify that the authenticated user has permission to create a task in the specified board (i.e., is a member of the board).
  - [ ] Map `CardRequest` to a `CardsModels` entity.
  - [ ] Save the new `CardsModels` entity using `CardRepository`.
  - [ ] Trigger the `ActivityLogService` to record the `CARD_CREATED` event.
  - [ ] Map the resulting entity to `CardResponse`.
- [ ] Implement `CardController` with a `POST /tasks` endpoint. (AC: 1, 5, 6)
  - [ ] Secure the endpoint with JWT authentication.
  - [ ] Call `CardService.createCard`.
  - [ ] Return `CardResponse` with HTTP status 201.
- [ ] Write unit tests for `CardService`. (AC: 1, 6)
  - [ ] Test successful task creation.
  - [ ] Test validation for required fields.
  - [ ] Test authorization logic (e.g., non-board member attempts to create a task).
- [ ] Write integration tests for the `POST /tasks` endpoint. (AC: 1, 5, 6)
  - [ ] Test the end-to-end flow, including authentication and authorization.
  - [ ] Verify the `ActivityLog` is created correctly.

## Dev Notes
### Data Models
- **Card (Task):** A new `CardsModels` entity will be created. Key attributes include `id`, `columnId`, `assigneeId`, `title`, `description`, `priority`, `dueDate`, `completionPercentage`, `createdAt`, `updatedAt`. [Source: architecture.md#4.5. Card (Task)]
- **ActivityLog:** An entry will be added to the `activity_logs` table with `eventType: CARD_CREATED`. [Source: architecture.md#4.7. ActivityLog]

### API Specifications
- **Endpoint:** `POST /tasks` (This is inferred from the "Create Task Workflow" diagram, as it's not explicitly in the OpenAPI spec yet).
- **Request Body:** `CardRequest` DTO containing `columnId`, `title`, `description`, `assigneeId`, `priority`, `dueDate`, `completionPercentage`.
- **Security:** Requires JWT `bearerAuth`. Authorization logic must be implemented in the service layer to check board membership.
- **Responses:** 201 Created (returns `CardResponse`), 400 Bad Request (invalid input), 403 Forbidden (user not a board member), 404 Not Found (e.g., `columnId` or `assigneeId` does not exist).
- [Source: architecture.md#7.1. Create Task Workflow]

### Component Specifications
- **Task Management Component:** This component is responsible for managing all operations related to Cards (Tasks).
- **Key Interfaces:** `CardService`, `CardRepository`.
- **Dependencies:** `User Management Component` (to validate assignee), `Project Management Component` (to verify board membership), `ActivityLogService` (to log the creation event).
- [Source: architecture.md#5.4. Task Management Component]

### File Locations (based on Source Tree)
- **DTOs:**
  - `backend/src/main/java/com/grupo5/taskflow/dto/CardRequest.java`
  - `backend/src/main/java/com/grupo5/taskflow/dto/CardResponse.java`
- **Model:** `backend/src/main/java/com/grupo5/taskflow/model/CardsModels.java`
- **Repository:** `backend/src/main/java/com/grupo5/taskflow/repository/CardRepository.java`
- **Service:** `backend/src/main/java/com/grupo5/taskflow/service/CardService.java`
- **Controller:** `backend/src/main/java/com/grupo5/taskflow/controller/CardController.java`
- [Source: architecture.md#10. Source Tree]

### Testing
- **Unit Tests:** Create `CardServiceTest.java` in `backend/src/test/java/com/grupo5/taskflow/service/`. Mock all repository and external service dependencies.
- **Integration Tests:** Add tests to a new `CardControllerIntegrationTest.java` in `backend/src/test/java/com/grupo5/taskflow/integration/`. Use `@SpringBootTest` and Testcontainers.
- **Standards:** Follow the AAA pattern. Aim for 80% line coverage.
- [Source: architecture.md#14. Test Strategy and Standards]

## Change Log
| Date | Version | Description | Author |
| :--- | :------ | :---------- | :----- |
| 2025-11-05 | 1.0 | Initial draft of story 2.2 | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List

## QA Results
