# Story 4.1: User Activity History

**Status:** Draft

**As a** user,
**I want** to view a comprehensive history of my activities, including board and task management actions,
**so that** I can track my contributions and understand my engagement within the system.

## Acceptance Criteria:

1.  A user can access an endpoint (e.g., `/users/{userId}/activity-history`) to retrieve a paginated list of their activities.
2.  The activity history includes actions related to:
    *   Creating, updating, or deleting boards.
    *   Joining or leaving boards.
    *   Creating, updating, or deleting tasks (cards).
    *   Assigning/unassigning tasks.
    *   Changing task status.
    *   Adding comments to tasks.
3.  Each activity entry includes:
    *   Timestamp of the activity.
    *   Type of event (e.g., `BOARD_CREATED`, `TASK_ASSIGNED`, `COMMENT_ADDED`).
    *   Relevant details (e.g., board name, task title, old/new status).
4.  The endpoint is secured with JWT authentication and appropriate authorization (users can only view their own history, Project Managers can view the history of users within their managed projects, and admins can view any user's history).
5.  The backend implements a service and repository to efficiently query and aggregate activity data.
6.  Unit and integration tests are implemented for the new service, repository, and controller methods.

## Dev Notes:

### Previous Story Insights:
No previous story insights as this is the first story being drafted.

### Data Models:
*   **User:** Existing model will be used to identify the user whose activity history is being retrieved. [Source: architecture/architecture.md#4.1-user]
*   **ActivityLog:** The existing `ActivityLog` model (`id`, `cardId`, `userId`, `eventType`, `details`, `timestamp`) will be extended.
    *   A new nullable field `boardId: UUID` should be added to the `ActivityLog` entity to link activities directly to boards. [Source: architecture/architecture.md#4.7-activitylog]
    *   The `eventType` enum (`com.grupo5.taskflow.model.enums.EventType`) needs to be expanded to include board-related events: `BOARD_CREATED`, `BOARD_UPDATED`, `BOARD_DELETED`, `BOARD_MEMBER_ADDED`, `BOARD_MEMBER_REMOVED`, `BOARD_MEMBER_ROLE_CHANGED`. [Source: architecture/architecture.md#4.7-activitylog]
*   **Board:** Existing model will be referenced for board-related activity details. [Source: architecture/architecture.md#4.2-board-(project)]
*   **BoardMember:** Existing model will be referenced for board membership changes. [Source: architecture/architecture.md#4.8-boardmember-(join-table-for-board-and-user)]

### API Specifications:
*   **Endpoint:** `GET /api/users/{userId}/activity-history` [Source: architecture/architecture.md#8-rest-api-spec]
    *   **Summary:** Retrieve a paginated list of a specific user's activity history.
    *   **Tags:** Users, Activity
    *   **Security:** `bearerAuth` (JWT) [Source: architecture/architecture.md#15.2-authentication-&-authorization]
    *   **Path Parameters:**
        *   `userId`: UUID (required) - The ID of the user whose activity history is to be retrieved.
    *   **Query Parameters:**
        *   `page`: Integer (optional, default 0) - Page number for pagination.
        *   `size`: Integer (optional, default 10) - Number of activity entries per page.
    *   **Responses:**
        *   `200 OK`: Returns a paginated list of `ActivityLogResponse` DTOs.
        *   `401 Unauthorized`: If no valid JWT is provided.
        *   `403 Forbidden`: If the authenticated user is not authorized to view the requested user's history.
        *   `404 Not Found`: If the `userId` does not exist.
*   **New DTO:** `ActivityLogResponse`
    *   Should include fields: `id`, `timestamp`, `eventType`, `details`, `cardId` (nullable), `boardId` (nullable), `userId`.

### Component Specifications:
No specific guidance found in architecture docs for frontend components. A new UI component would be needed to display this activity history, likely a table or list view.

### File Locations:
*   **Backend:**
    *   Update `backend/src/main/java/com/grupo5/taskflow/model/ActivityLogsModels.java` to include `boardId` and potentially update `EventType` enum. [Source: architecture/architecture.md#10-source-tree]
    *   Update `backend/src/main/java/com/grupo5/taskflow/model/enums/EventType.java` to add new board-related event types. [Source: architecture/architecture.md#10-source-tree]
    *   Update `backend/src/main/java/com/grupo5/taskflow/repository/ActivityLogRepository.java` to add methods for querying activity logs by `userId` and `boardId`. [Source: architecture/architecture.md#10-source-tree]
    *   Create new service `backend/src/main/java/com/grupo5/taskflow/service/ActivityLogService.java` to encapsulate business logic for retrieving and aggregating user activities. [Source: architecture/architecture.md#10-source-tree]
    *   Update `backend/src/main/java/com/grupo5/taskflow/controller/UserController.java` or create a new `ActivityLogController` to expose the new API endpoint. [Source: architecture/architecture.md#10-source-tree]
    *   Create new DTO `backend/src/main/java/com/grupo5/taskflow/dto/ActivityLogResponse.java`. [Source: architecture/architecture.md#10-source-tree]

### Testing Requirements:
*   **Unit Tests:**
    *   `ActivityLogServiceTest.java`: Cover methods for retrieving user activity, handling pagination, and filtering. Mock `ActivityLogRepository`. [Source: architecture/architecture.md#14.2.1-unit-tests]
    *   `ActivityLogRepositoryTest.java`: Test new repository methods for querying activity logs by user and board. [Source: architecture/architecture.md#14.2.1-unit-tests]
*   **Integration Tests:**
    *   `UserControllerIntegrationTest.java` (or `ActivityLogControllerIntegrationTest.java`): Test the `/api/users/{userId}/activity-history` endpoint, including authentication, authorization (for regular users, Project Managers, and administrators), and correct data retrieval. Specifically, test that a Project Manager can only view activities for users within their managed projects. Use `@SpringBootTest` and Testcontainers with MySQL. (AC: 6)
*   **General:** Follow AAA pattern (Arrange, Act, Assert). Aim for 80% line coverage for services and controllers. [Source: architecture/architecture.md#14.2.1-unit-tests]

### Technical Constraints:
*   **Language & Framework:** Java 21, Spring Boot 3.2.0. [Source: architecture/architecture.md#3.2-technology-stack-table]
*   **Build Tool:** Maven 3.9.5. [Source: architecture/architecture.md#3.2-technology-stack-table]
*   **Database:** H2 for local development and automated tests, MySQL for production and staging. [Source: architecture/architecture.md#3.2-technology-stack-table]
*   **Security:** JWT-based authentication and RBAC using Spring Security (`@PreAuthorize`). [Source: architecture/architecture.md#15.2-authentication-&-authorization]
*   **Logging:** Use SLF4J with Logback; avoid `System.out.println()`. [Source: architecture/architecture.md#12.2-logging-standards, architecture/architecture.md#13.3-critical-rules]
*   **DTO Usage:** All API data exchange must use DTOs. [Source: architecture/architecture.md#13.3-critical-rules]
*   **Database Access:** All database interactions must go through the Repository pattern (Spring Data JPA). [Source: architecture/architecture.md#13.3-critical-rules]

## Tasks / Subtasks:

1.  **Backend - Data Model & Repository:**
    *   Update `ActivityLogsModels.java` to add `boardId` (nullable UUID) field. (AC: 2)
    *   Update `EventType.java` enum to include new board-related event types (`BOARD_CREATED`, `BOARD_UPDATED`, `BOARD_DELETED`, `BOARD_MEMBER_ADDED`, `BOARD_MEMBER_REMOVED`, `BOARD_MEMBER_ROLE_CHANGED`). (AC: 2)
    *   Update `ActivityLogRepository.java` to include methods for querying `ActivityLog` entries by `userId` and `boardId`, with pagination support. (AC: 5)
    *   *Unit Test:* `ActivityLogRepositoryTest.java` for new query methods. (AC: 6)
2.  **Backend - Service Layer:**
    *   Create `ActivityLogService.java` with a method to retrieve a paginated list of `ActivityLogResponse` DTOs for a given `userId`. This service should aggregate activities from both `ActivityLog` (for tasks) and potentially `Board` and `BoardMember` (for board-related actions). (AC: 1, 2, 3, 5)
    *   Implement logic to record board-related activities (creation, updates, member changes) into the `ActivityLog` table. This might involve modifying `BoardService` and `BoardMemberService`. (AC: 2)
    *   *Unit Test:* `ActivityLogServiceTest.java` covering activity retrieval, pagination, and event aggregation. (AC: 6)
3.  **Backend - DTOs:**
    *   Create `ActivityLogResponse.java` DTO with fields: `id`, `timestamp`, `eventType`, `details`, `cardId` (nullable), `boardId` (nullable), `userId`. (AC: 3)
4.  **Backend - Controller Layer:**
    *   Add a new `GET /api/users/{userId}/activity-history` endpoint to `UserController.java` (or a new `ActivityLogController.java`). (AC: 1)
    *   Implement JWT authentication and `@PreAuthorize` for authorization. The logic must check:
        *   If the caller is an ADMIN.
        *   If the caller's ID matches the `userId` path variable.
        *   If the caller is a Project Manager for the projects the target user is a member of. (This may require a custom permission evaluator). (AC: 4)
    *   Map `ActivityLog` entities to `ActivityLogResponse` DTOs. (AC: 3)
    *   *Integration Test:* `UserControllerIntegrationTest.java` (or `ActivityLogControllerIntegrationTest.java`) for the new endpoint, covering authentication, authorization, pagination, and data correctness. (AC: 6)
5.  **Database Schema Update:**
    *   Generate/apply a database migration to add the `board_id` column (BINARY(16), nullable) to the `activity_logs` table. (AC: 5)

## Project Structure Notes:
*   The new `ActivityLogService` will reside in `backend/src/main/java/com/grupo5/taskflow/service/`.
*   The `ActivityLogResponse` DTO will reside in `backend/src/main/java/com/grupo5/taskflow/dto/`.
*   The new endpoint will be added to `backend/src/main/java/com/grupo5/taskflow/controller/UserController.java` or a new controller.
*   Test files will follow the conventions in `backend/src/test/java/com/grupo5/taskflow/`.

