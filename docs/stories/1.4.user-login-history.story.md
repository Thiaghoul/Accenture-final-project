# Story 1.4: User Login History

**Status:** Draft

**As a** user or administrator,
**I want** to view the login history for a user account,
**so that** I can monitor for suspicious activity and track account access.

## Acceptance Criteria:

1.  Every successful login attempt is recorded in the database.
2.  Every failed login attempt (due to incorrect password) is recorded in the database.
3.  Each login history record includes the user's email, timestamp, IP address, user agent, and a success/failure status.
4.  A new secured API endpoint (e.g., `/api/users/{userId}/login-history`) is created to retrieve a paginated list of login attempts for a specific user.
5.  The endpoint is secured with JWT authentication and appropriate authorization (a user can only view their own login history, while an administrator can view the history for any user).
6.  Unit and integration tests are implemented for the new functionality.

## Dev Notes:

### Previous Story Insights:
This story builds upon the authentication flow established in Story 1.3. The login process in the `Authentication Component` will be the primary integration point.

### Data Models:
*   **New Model: `LoginHistory`**
    *   **Purpose:** To record every login attempt against the system.
    *   **Key Attributes:**
        *   `id`: UUID - Unique identifier for the login attempt.
        *   `userId`: UUID (nullable) - Foreign key to the `User` who attempted to log in. Nullable to record attempts with non-existent emails.
        *   `email`: String - The email address used for the login attempt.
        *   `timestamp`: Instant - Timestamp of the login attempt.
        *   `ipAddress`: String - The IP address from which the attempt originated.
        *   `userAgent`: String - The user agent string of the client.
        *   `wasSuccessful`: Boolean - True for a successful login, false otherwise.
    *   **Relationships:** A `LoginHistory` entry is associated with one `User` (if the user exists).
*   **User:** The existing `User` model will be referenced. [Source: architecture/architecture.md#4.1-user]

### API Specifications:
*   **Endpoint:** `GET /api/users/{userId}/login-history` [Source: architecture/architecture.md#8-rest-api-spec]
    *   **Summary:** Retrieve a paginated list of a specific user's login history.
    *   **Tags:** Users, Security
    *   **Security:** `bearerAuth` (JWT) [Source: architecture/architecture.md#15.2-authentication-&-authorization]
    *   **Path Parameters:**
        *   `userId`: UUID (required) - The ID of the user whose login history is to be retrieved.
    *   **Query Parameters:**
        *   `page`: Integer (optional, default 0) - Page number for pagination.
        *   `size`: Integer (optional, default 10) - Number of entries per page.
    *   **Responses:**
        *   `200 OK`: Returns a paginated list of `LoginHistoryResponse` DTOs.
        *   `401 Unauthorized`: If no valid JWT is provided.
        *   `403 Forbidden`: If the authenticated user is not authorized to view the requested user's history.
        *   `404 Not Found`: If the `userId` does not exist.
*   **New DTO:** `LoginHistoryResponse`
    *   Should include fields: `id`, `timestamp`, `ipAddress`, `userAgent`, `wasSuccessful`.

### Component Specifications:
*   **Authentication Component:** The `AuthService` will be modified to include the logic for recording login attempts. This is the core integration point for this feature. [Source: architecture/architecture.md#5.1-authentication-component]

### File Locations:
*   **Backend:**
    *   Create new model: `backend/src/main/java/com/grupo5/taskflow/model/LoginHistory.java`. [Source: architecture/architecture.md#10-source-tree]
    *   Create new repository: `backend/src/main/java/com/grupo5/taskflow/repository/LoginHistoryRepository.java`. [Source: architecture/architecture.md#10-source-tree]
    *   Update `backend/src/main/java/com/grupo5/taskflow/service/AuthService.java` to call the `LoginHistoryRepository` to save login attempts. [Source: architecture/architecture.md#10-source-tree]
    *   Create new service `backend/src/main/java/com/grupo5/taskflow/service/LoginHistoryService.java` to handle the business logic for retrieving login history. [Source: architecture/architecture.md#10-source-tree]
    *   Update `backend/src/main/java/com/grupo5/taskflow/controller/UserController.java` to add the new API endpoint. [Source: architecture/architecture.md#10-source-tree]
    *   Create new DTO `backend/src/main/java/com/grupo5/taskflow/dto/LoginHistoryResponse.java`. [Source: architecture/architecture.md#10-source-tree]

### Testing Requirements:
*   **Unit Tests:**
    *   `AuthServiceTest.java`: Add tests to verify that both successful and failed login attempts correctly trigger the recording of a `LoginHistory` entry. Mock `LoginHistoryRepository`. [Source: architecture/architecture.md#14.2.1-unit-tests]
    *   `LoginHistoryServiceTest.java`: Test the logic for retrieving login history, including pagination. Mock `LoginHistoryRepository`. [Source: architecture/architecture.md#14.2.1-unit-tests]
*   **Integration Tests:**
    *   `UserControllerIntegrationTest.java`: Add tests for the `/api/users/{userId}/login-history` endpoint, covering authentication, authorization (for both user and admin roles), and correct data retrieval. Use `@SpringBootTest`. [Source: architecture/architecture.md#14.2.2-integration-tests]
*   **General:** Follow AAA pattern (Arrange, Act, Assert). Aim for 80% line coverage. [Source: architecture/architecture.md#14.2.1-unit-tests]

### Technical Constraints:
*   **Security:** The `AuthService` modification must be carefully implemented to not interfere with the primary authentication flow. The new endpoint must be secured with RBAC. [Source: architecture/architecture.md#15.2-authentication-&-authorization]
*   **Data Privacy:** IP addresses and user agents can be considered PII. Handle this data according to the project's data protection policies. [Source: architecture/architecture.md#15.5-data-protection]

## Tasks / Subtasks:

1.  **Backend - Data Model & Repository:**
    *   Create the `LoginHistory.java` JPA entity with the specified attributes. (AC: 3)
    *   Create the `LoginHistoryRepository.java` Spring Data JPA interface. (AC: 1, 2)
    *   *Unit Test:* `LoginHistoryRepositoryTest.java` to ensure basic CRUD operations work. (AC: 6)
2.  **Backend - Service Layer (Authentication):**
    *   Inject `LoginHistoryRepository` into `AuthService.java`.
    *   Modify the login method in `AuthService.java` to create and save a `LoginHistory` entity after every login attempt (successful or failed). (AC: 1, 2, 3)
    *   *Unit Test:* Update `AuthServiceTest.java` to verify that the repository's `save` method is called on login. (AC: 6)
3.  **Backend - Service Layer (History Retrieval):**
    *   Create `LoginHistoryService.java` with a method to retrieve a paginated list of `LoginHistoryResponse` DTOs for a given `userId`. (AC: 4)
    *   *Unit Test:* `LoginHistoryServiceTest.java` covering the retrieval logic. (AC: 6)
4.  **Backend - DTO:**
    *   Create `LoginHistoryResponse.java` DTO. (AC: 4)
5.  **Backend - Controller Layer:**
    *   Add a new `GET /api/users/{userId}/login-history` endpoint to `UserController.java`. (AC: 4)
    *   Implement JWT authentication and `@PreAuthorize` for authorization (e.g., `hasRole('ADMIN') or #userId == principal.id`). (AC: 5)
    *   *Integration Test:* `UserControllerIntegrationTest.java` for the new endpoint. (AC: 6)
6.  **Database Schema Update:**
    *   Generate/apply a database migration to create the `login_history` table with appropriate columns and foreign keys.

## Project Structure Notes:
*   All new Java classes will be placed in their respective packages (`model`, `repository`, `service`, `dto`, `controller`) under `com.grupo5.taskflow` as per the defined source tree. [Source: architecture/architecture.md#10-source-tree]
*   Test files will mirror the main package structure in `src/test/java`. [Source: architecture/architecture.md#10-source-tree]
