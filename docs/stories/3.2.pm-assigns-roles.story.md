# Story 3.2: Project Manager Assigns Roles to Members

## Status
Draft

## Story
**As a** Project Manager,
**I want** to assign roles (e.g., Manager, Editor, Viewer) to project members,
**so that** I can control their permissions and access levels within the board.

## Acceptance Criteria
1. A Project Manager can change the role of another member on a board they manage.
2. The `role` in the `BoardMember` join table is updated to the new role.
3. An `ActivityLog` entry is created on the board to record the `BOARD_MEMBER_ROLE_CHANGED` event.
4. The API returns the updated member details.
5. A Project Manager cannot change their own role if they are the last manager on the board.
6. Only Project Managers of the board can change member roles.

## Tasks / Subtasks
- [ ] Create `UpdateMemberRoleRequest` DTO containing the `newRole`.
- [ ] Implement a `updateMemberRole` method in `BoardService`. (AC: 1, 2, 3, 5, 6)
  - [ ] Verify the authenticated user is a 'Manager' for the board.
  - [ ] Implement logic to prevent the last manager from changing their own role.
  - [ ] Find the `BoardMember` entity for the target user and board.
  - [ ] Update the `role` field.
  - [ ] Create a board-level `ActivityLog` entry.
- [ ] Implement a `PUT /projects/{boardId}/members/{userId}` endpoint in `BoardController`. (AC: 1, 4, 6)
  - [ ] Secure the endpoint with JWT authentication.
  - [ ] Call `BoardService.updateMemberRole`.
- [ ] Write unit tests for `BoardService`'s `updateMemberRole` method, including the "last manager" edge case.
- [ ] Write integration tests for the `PUT /projects/{boardId}/members/{userId}` endpoint.

## Dev Notes
### Data Models
- **BoardMember:** The `role` field of an existing `BoardMember` entity will be updated. The `role` is an enum (e.g., MANAGER, EDITOR, VIEWER).
- **ActivityLog:** A new entry will be created with `eventType: BOARD_MEMBER_ROLE_CHANGED`.
- [Source: architecture.md#4.8.-BoardMember-(Join-Table-for-Board-and-User), architecture.md#4.7.-ActivityLog]

### API Specifications
- **Endpoint:** `PUT /projects/{boardId}/members/{userId}`
- **Security:** Requires JWT `bearerAuth`. Caller must be a 'Manager' of the board.
- **Path Parameters:** `boardId` (UUID), `userId` (UUID).
- **Request Body:** `UpdateMemberRoleRequest` DTO with `newRole`.
- **Responses:** 200 OK (with updated member details), 400 Bad Request (last manager cannot change role), 403 Forbidden, 404 Not Found.

### Component Specifications
- **Project Management Component:** The `BoardService` will be extended to handle role management.
- [Source: architecture.md#5.3.-Project-Management-Component]

### File Locations (based on Source Tree)
- **DTO:** `backend/src/main/java/com/grupo5/taskflow/dto/UpdateMemberRoleRequest.java`
- **Service:** `backend/src/main/java/com/grupo5/taskflow/service/BoardService.java` (updated)
- **Controller:** `backend/src/main/java/com/grupo5/taskflow/controller/BoardController.java` (updated)
- [Source: architecture.md#10.-Source-Tree]

### Testing
- **Unit Tests:** Update `BoardServiceTest.java`.
- **Integration Tests:** Update `BoardControllerIntegrationTest.java`.
- [Source: architecture.md#14.-Test-Strategy-and-Standards]

## Change Log
| Date | Version | Description | Author |
| :--- | :------ | :---------- | :----- |
| 2025-11-05 | 1.0 | Initial draft of story 3.2 | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List

## QA Results
